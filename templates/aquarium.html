<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒã‚¤æ°´æ—é¤¨ - çŸ³å·ã•ã‹ãªå·¡ã‚Š</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body class="bg-blue-900 min-h-screen flex flex-col items-center overflow-hidden">

    <main class="relative w-full flex-grow ocean-bg overflow-hidden flex items-center justify-center">
        <div class="absolute z-0 opacity-20 pointer-events-none">
            <h2 class="text-5xl font-black text-white leading-tight text-center">çŸ³å·<br>ãŠã•ã‹ãªæ°´æ—é¤¨</h2>
        </div>

        <div id="bubble-container" class="absolute inset-0 pointer-events-none"></div>

        <div id="fish-tank" class="relative w-full h-full z-10">
            </div>
    </main>

    <div id="talk-bubble" class="fixed bottom-24 left-1/2 -translate-x-1/2 bg-white/90 backdrop-blur px-6 py-3 rounded-2xl shadow-xl hidden z-50 transition-all">
        <p id="fish-message" class="text-blue-900 font-bold text-sm"></p>
    </div>

    <nav class="w-full bg-white/90 backdrop-blur border-t border-gray-100 px-6 py-3 flex justify-around items-center z-50">
        <a href="/" class="flex flex-col items-center text-gray-400 hover:text-cyan-600 transition-colors">
            <span class="text-2xl">ğŸ²</span><span class="text-[10px] font-bold">ã™ã”ã‚ã</span>
        </a>
        <a href="/encyclopedia" class="flex flex-col items-center text-gray-400 hover:text-cyan-600 transition-colors">
            <span class="text-2xl">ğŸ“•</span><span class="text-[10px] font-bold">å›³é‘‘</span>
        </a>
        <a href="/aquarium" class="flex flex-col items-center text-cyan-600">
            <span class="text-2xl">ğŸŒŠ</span><span class="text-[10px] font-bold">æ°´æ—é¤¨</span>
        </a>
    </nav>

    <script>
        // 1. ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æ‰€æŒã—ã¦ã„ã‚‹é­šã®ãƒªã‚¹ãƒˆã‚’å–å¾—
        async function loadAquarium() {
            try {
                const response = await fetch('/api/collection');
                const data = await response.json();
                const tank = document.getElementById('fish-tank');
                
                // æ‰€æŒã—ã¦ã„ã‚‹(is_owned: true)ã®é­šã ã‘ã‚’è¡¨ç¤º
                const myFishes = data.filter(f => f.is_owned);

                myFishes.forEach((fish, index) => {
                    const fishEl = document.createElement('div');
                    fishEl.className = 'fish-instance text-4xl';
                    fishEl.innerHTML = 'ğŸŸ'; // æœ¬æ¥ã¯fish.idãªã©ã«å¿œã˜ã¦ç”»åƒã‚’å¤‰ãˆã‚‹
                    
                    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«ãšã‚‰ã™
                    const duration = 15 + Math.random() * 10; // 15ã€œ25ç§’
                    const delay = Math.random() * -20; // é–‹å§‹ä½ç½®ã‚’ãƒãƒ©ã‘ã•ã›ã‚‹
                    const top = 20 + Math.random() * 60; // ç”»é¢ã®20%ã€œ80%ã®é«˜ã•
                    
                    fishEl.style.setProperty('--duration', `${duration}s`);
                    fishEl.style.setProperty('--delay', `${delay}s`);
                    fishEl.style.top = `${top}%`;

                    // ã‚¯ãƒªãƒƒã‚¯ã§ãŠã—ã‚ƒã¹ã‚Š
                    fishEl.onclick = () => {
                        const msg = document.getElementById('fish-message');
                        const bubble = document.getElementById('talk-bubble');
                        msg.innerText = `${fish.name}ã ã€‚çŸ³å·ã®æµ·ã¯æœ€é«˜ã ã‚ˆï¼`;
                        bubble.classList.remove('hidden');
                        setTimeout(() => bubble.classList.add('hidden'), 3000);
                    };

                    tank.appendChild(fishEl);
                });
            } catch (e) {
                console.error("æ°´æ—é¤¨ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ", e);
            }
        }

        // 2. æ³¡ã‚’ç”Ÿæˆã™ã‚‹æ¼”å‡º
        function createBubbles() {
            const container = document.getElementById('bubble-container');
            for (let i = 0; i < 15; i++) {
                const b = document.createElement('div');
                b.className = 'bubble';
                const size = 10 + Math.random() * 20;
                b.style.width = `${size}px`;
                b.style.height = `${size}px`;
                b.style.left = `${Math.random() * 100}%`;
                b.style.animationDelay = `${Math.random() * 10}s`;
                container.appendChild(b);
            }
        }

        window.onload = () => {
            loadAquarium();
            createBubbles();
        };
    </script>
</body>
</html>